<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Just Search Portal</title> 
<link rel="shortcut icon" type="image/x-icon" href="data:image/x-icon;,">
<link rel="search" type="application/opensearchdescription+xml" href="opensearch.xml" title="Just Search Portal" />
<meta id="viewport" name="viewport">
<script type="text/javascript">

// This file with its HTML, CSS and JavaScript is free software under the terms of the following license: https://justsearchportal.com/LICENSE

// Mobile viewport hack, from: 
// https://stackoverflow.com/a/39642318
function apply_viewport() {    
	var ww = window.screen.width;
	var mw = 450;
	var viewport_meta_tag = document.getElementById('viewport');
	if( ww < mw) { 
		var ratio = ww / mw;
		viewport_meta_tag.setAttribute('content', 'initial-scale=' + ratio + ', maximum-scale=' + ratio + ', minimum-scale=' + ratio + ', user-scalable=no, width=' + mw);
	}    
}
window.addEventListener('resize', function(){ apply_viewport(); });
apply_viewport();

// Inline favicon technique from:
// https://stackoverflow.com/a/5568484

var favIcon = "\
iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAABj0lEQVQ4y5WSsU4iURSGv3sv6FDgA1i\
QaLOikcTOcmMpUl4TMfEB9gkoMLGg4Al8g53CKSHWFlvYmVgw05nQagUmzAIzd4sZLiCDuqc4zTnnyz\
n/+YU2KADvfqdEtFlHbuxjzBEAQjwRT251zX9kTQhtUF6nfIzM/0I6dQCikY8qlG3XdNDUtaCdBZBJT\
ofj0CUK68j3KuZ1l+mgSTTyyW21vM5eI3MDOpULlOMShy5i2NSnL/3FBq9bOUc5LtHIR75XP9YlgjMA\
DN2PRQB99nxHHLqoQpnI2V49YSaYHK4VinjcS/bNl1YBQjwlwq3S510b+2tLlo75mdXg3e+U7JZm0s/\
4gnhYp3QyXGyhCmXi0M3yQ+qDvQa5rVZyb+jaqjFHiXgjHzP5DYD66y6KLawTu5VzMNdLBpoB43EPkb\
+cbbL4bguY29nZtmrL4aM+felbLyxCU8gS4LNYOjOF6OrzlTq4Se38RRz8ePvTC4pj5OZJcnzusBcUx\
98atq6sBW2mg+bKF/jPmL1b14L2P96CtjFufhdDAAAAAElFTkSuQmCC";

var docHead = document.getElementsByTagName('head')[0];
var newLink = document.createElement('link');
newLink.rel = 'shortcut icon';
newLink.type = 'image/x-icon';
newLink.href = 'data:image/png;base64,'+favIcon;
docHead.appendChild(newLink);
</script>

<style>
html, body {
	height: 100%;
	margin: 0;
	font-family: helvetica, sans-serif;
}

.container {
	min-width: 480px;
	width: auto !important;
	height: 100%;
	display: flex;
	flex-direction: column;
}

.footer {
	width: fill;
	margin: 0 20px;
	border-top: 2px solid #a0a0a0;
	text-align: center;
}

.footer p {
	font-size: 11pt;
	margin:0.6em 0 0.8em 0;
}

.centerContainer {
	margin: auto;
	text-align: center;
}

.centerbox {
	margin: auto;
	text-align: center;
}

.title {
	font-weight: bold;
	font-size: 50pt;
	color: #d7d7d7;
	margin: 8px 0 15px 0;
}

.btn {
	background-color: #a7e7a7;
	border: 2px solid #a0a0a0;
	vertical-align: bottom;
	color: black;
	width: 150px;
	height: 44px;
	display: inline-block;
	font-size: 15px;
	margin: 10px;
	cursor: pointer;
}

.btnDefault {
	border: 3px solid #404040;
}

.searchInput {
	width: 80%;
	margin: 20px 0 35px 0;
	font-size: 16pt;
}

.checkbox {
	color: #303030;
	margin: 20px;
}

label, input[type=checkbox] {
	cursor: pointer;
}
</style>
</head>

<body>
	<div class="container">
		<div class="centerContainer">
		<div class="centerbox">
			<p class="title">Just Search</p>
			<form id="searchForm" autocomplete="off">			
			<input type="search" id="query" class="searchInput" placeholder="Type query here" autocomplete="off" autofocus />			
			</form>
						
			<div id="engines"></div>
			
			<div class="checkbox">
				<label><input type="checkbox" id="newTab" onClick="usrClickNewTab()">Open in new tab</label>
				 	&nbsp; 	&nbsp; 	&nbsp;
				<label><input type="checkbox" id="showAll" onClick="usrClickShowAll()">Show all engines</label>
			</div>
			
			<p><a href="customize.html">Customize Page</a></p>
		</div>
		</div>
		<div class="footer">
			<p>Just Search Portal - Without distractions - Respecting privacy - <a href="https://github.com/larspontoppidan/just-search-portal">GitHub</a> - <a href="https://larsee.com/blog/2018/02/just-search-portal/">About</a></p>
		</div>
	</div>
	<script src="enginelist.js"></script>
	<script src="common.js"></script>
	<script>
    
		var searchForm = document.getElementById('searchForm');
		var newTab = document.getElementById('newTab');
		var showAll = document.getElementById('showAll');
		
		var state = loadState();
		
		if (!isStateValid(state)) {
			state = loadDefaults();
		}
		
		newTab.checked = state.newTab;
		showAll.checked = state.showAll;
		
    	function getEngineFromKey(key) {
    		ret = {};
    		searchEngineList.forEach((category) => {
    	    	category.engines.forEach((engine) => {
    	    		if (engine.key == key) {
    	    			ret = engine;
    	    		}
    	    	});
    		});
   	    	return ret;
    	}
    	    	
		function makeDefaultEngineButtons() {
			var div = document.createElement('div');
			state.searchEngines.forEach((entry) => {
				var elem;
	        	if (entry.key == "NEWLINE") {
	        		elem = document.createElement('br');
	        	}
	        	else {
	        		elem = createSearchButton(entry, engineClick, entry.key);
	        	}
        		div.appendChild(elem);
        	});	
			return div;
		}
    	
		function makeAllEngineButtons() {
			var tbl = document.createElement('table');
	        tbl.classList.add("manageTable");
			var tr = tbl.insertRow();
			searchEngineList.forEach((category) => {
				var th = document.createElement('th');
		        th.innerHTML = category.category;		        
		        tr.appendChild(th);
			});
			
			var i = 0;
			var enginesAdded;
			do {
				enginesAdded = false;
				tr = tbl.insertRow();
				searchEngineList.forEach((category) => {
					var td = tr.insertCell();
					if (i < category.engines.length) {
						var engine = category.engines[i];
				        td.appendChild(createSearchButton(engine, engineClick, engine.key));
				        enginesAdded = true;
					}
	    		});
				i += 1;
			} while (enginesAdded);
			
			return tbl;
		}
		
		function usrClickNewTab() {
			state.newTab = newTab.checked;
			saveState(state);
		}
		
		function usrClickShowAll() {
			state.showAll = showAll.checked; 
			saveState(state);
			engines.removeChild(engines.firstChild);
			if (state.showAll) {
				engines.appendChild(makeAllEngineButtons());
			}
			else {
				engines.appendChild(makeDefaultEngineButtons());			
			}
		}
		
		var engines = document.getElementById('engines');
		
		if (state.showAll) {
			engines.appendChild(makeAllEngineButtons());
		}
		else {
			engines.appendChild(makeDefaultEngineButtons());			
		}
		
		function submitClick() {
			if (newTab.checked) {				
				new_tab_index = 0;
			}
			else {
				new_tab_index = state.engines.length;
			}
			query = document.getElementById('query').value;
			state.searchEngines.forEach((entry) => {
				if (entry.isDefault) {
					new_tab_index -= 1;
					engine = getEngineFromKey(entry.key);
					search(engine, query, (new_tab_index != 0));					
				}
			});
		}
		
		if (!Array.prototype.remove) {
			Array.prototype.remove = function(val) {
				var i = this.indexOf(val);
				return i>-1 ? this.splice(i, 1) : [];
			};
		}

		searchForm.addEventListener('submit', function(e) {
			e.preventDefault();
			submitClick();
		});

		function engineClick() {			
			search(getEngineFromKey(this.id), document.getElementById('query').value, newTab.checked);
		}
		
		function stringTrim(str) 
		{
			return str.replace(/^\s+|\s+$/g, '');
		}
		
		function processUrl(query) {
	    	// Add http protocol if no protocol is specified in query
		    if (!(new RegExp("^[a-zA-Z0-9+.-]+://.+")).test(query)) {
		        query = "http://" + query;
		    }
	    	return query;
	    }
		
		function search(engine, query, new_tab) {			
			var url = engine.query_url;
			query = stringTrim(query);
			if (engine.mode == null) {
				// Reduce repeating spaces, then URI encode, then convert space to plus if needed
				query = encodeURIComponent(query.replace(/  +/g, ' '));
				url = url.replace("$QUERY_PLUS_SEP", query.replace(/%20/g, '+'));
				url = url.replace("$QUERY", query);
			}
			else if (engine.mode == "URL") {
				url = processUrl(query);
			}
			else {
				return;
			}

			if (new_tab) {
				var win = window.open(url, '_blank');
				win.focus();
			} else {
				window.location.href = url;
			}
		}
		
		function getUrlParam(url, param, fallback) {
			var capture = (new RegExp(param + "=([^&]+)")).exec(url);
			return capture ? decodeURIComponent(capture[1]) : fallback;
		}
		
		function handleHashChange() {
			var url = window.location.hash;
			document.getElementById('query').value = getUrlParam(url, "query", "").replace(/\+/g, " ");			
		}

		window.onhashchange = handleHashChange;
		handleHashChange();
		
	</script>
</body>	
</html>
